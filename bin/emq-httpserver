#!/usr/bin/env python
# -*- mode: python -*-
#
# This file is part of eventmq.
#
# eventmq is free software: you can redistribute it and/or modify it under the
# terms of the GNU Lesser General Public License as published by the Free
# Software Foundation, either version 2.1 of the License, or (at your option)
# any later version.
#
# eventmq is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License
# along with eventmq.  If not, see <http://www.gnu.org/licenses/>.
import argparse
from wsgiref.simple_server import make_server

from eventmq import conf, log
from eventmq.http import wsgi

logger = log.setup_logger()


if __name__ == "__main__":
    parser = argparse.ArgumentParser(
        description='Starts built-in HTTP server for web based control panel.')

    parser.add_argument('--broker-addr', '-B',
                        help='manually specify the broker address to connect '
                             'to in order to receive jobs',
                        type=str, nargs='?')
    parser.add_argument('--config', '-C',
                        help='manually specify the location of eventmq.conf',
                        type=str, nargs='?')
    parser.add_argument('--host', '-H',
                        help='Address to listen for connections Default: '
                             '127.0.0.1',
                        type=str, default='127.0.0.1', nargs='?')
    parser.add_argument('--port', '-P',
                        help='Port to listesn for new connections Default: '
                             '8080',
                        type=int, nargs='?', default=8080)

    args = parser.parse_args()

    # Overwrite the default config location with the one passed to the app
    if args.config:
        conf.CONFIG_FILE = args.config

    broker_addr = args.broker_addr
    host_addr = args.host
    host_port = args.port

    logger.info("Listening for new connections on http://{}:{}".format(
        host_addr, host_port))

    server = make_server(host_addr, host_port, wsgi.application)
    server.serve_forever()
